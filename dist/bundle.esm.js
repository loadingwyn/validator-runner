function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}var Validator=function(){function e(r){var t=this;_classCallCheck(this,e),this.transformToPromise=function(e,r,n,a){var o=r.validator.apply(r,_toConsumableArray(n)),i=!0;o&&o.then&&o.catch||(i=!1,o=o?Promise.resolve(o):Promise.reject(o));var u={errors:a,fieldName:e,target:n,isAsync:i};return o.then(function(e){return Object.assign(u,{promiseValue:e})},function(e){return u.errors=t.messageHandler(a,r.message,n,e),Promise.reject(Object.assign(u,{promiseValue:e}))})},this.lastValidator={},this.descriptor=r}return _createClass(e,[{key:"validateItem",value:function(e,r,t){var n,a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{first:!0,cover:!0,concurrent:!1},i=[],u=(arguments.length>4?arguments[4]:void 0)||this.descriptor[r];if(u&&!(u.length<1))return Array.isArray(u)||(u=[u]),n=o.concurrent?Promise.all(u.map(function(t){var n=[r].concat(_toConsumableArray(t.join||[])).map(function(r){return e[r]});return a.transformToPromise(r,t,n,i).then(function(e){return e},o.first?null:function(e){return e})})):u.reduce(function(t,n){var u=[r].concat(_toConsumableArray(n.join||[])).map(function(r){return e[r]});return t.then(function(){return a.transformToPromise(r,n,u,i)},o.first?null:function(){return a.transformToPromise(r,n,u,i)})},Promise.resolve()),this.lastValidator[r]=n,n.then(function(e){return(!o.cover||a.lastValidator[r]===n)&&t&&t(i,e),e},function(e){return(!o.cover||a.lastValidator[r]===n)&&t&&t(i,e),Promise.reject(e)});t(i,{})}},{key:"validate",value:function(e,r,t){var n=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=!1,i={},u=[];return(t||Object.keys(this.descriptor)).forEach(function(r){u.push(n.validateItem(e,r,function(e){i[r]=e},a))}),Promise.all(u.map(function(e){return e.catch(function(e){return o=!0,e})})).then(function(){return r(i,!o),o?Promise.reject(i):i})}},{key:"messageHandler",value:function(e,r,t,n){return"function"==typeof r?e.push("".concat(r.apply(void 0,_toConsumableArray(t).concat([n]))||"Error!").trim()):e.push("".concat(r||"Error!").trim()),e}},{key:"cancelItem",value:function(e){this.lastValidator[e]=null}},{key:"cancelAll",value:function(){this.lastValidator={}}},{key:"addRule",value:function(e){this.ruleSet=Object.assign(this.ruleSet,e)}},{key:"updateRuleSet",value:function(e){this.ruleSet=e}},{key:"deleteRule",value:function(e){delete this.ruleSet[e]}}]),e}();export default Validator;
